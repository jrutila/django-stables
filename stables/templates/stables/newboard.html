{% extends "base.html" %}
{% load i18n sekizai_tags stablestags %}
{% block content %}
{% addtoblock "js" %}
<script type='text/javascript' src="{{ STATIC_URL }}stables/js/dashboard.js"></script>
<script type='text/javascript' src="{{ STATIC_URL }}js/jquery.cookie.js"></script>
<script type='text/javascript' src="{{ STATIC_URL }}js/underscore-min.js"></script>
<script type='text/javascript' src="{{ STATIC_URL }}js/backbone-min.js"></script>
<script type='text/javascript' src="{{ STATIC_URL }}js/backbone-tastypie.js"></script>
<script type='text/javascript' src="{{ STATIC_URL }}stables/js/tooltipTextarea.js"></script>
<script type='text/javascript' src="{{ STATIC_URL }}stables/js/modules/participation.js"></script>
<script type='text/javascript' src="{{ STATIC_URL }}stables/js/modules/dashboard.js"></script>
<script type='text/javascript'>
    Backbone.Tastypie.csrfToken = $.cookie( 'csrftoken' )

    Date.prototype.addDays = function(days) {
        var dat = new Date(this.valueOf())
        dat.setDate(dat.getDate() + days);
        return dat;
    }

    Date.prototype.toISODate = function() {
        return this.toISOString().split("T")[0]
    }

    function getDates(startDate, stopDate) {
        var dateArray = new Array();
        var currentDate = startDate;
        while (currentDate <= stopDate) {
            dateArray.push( new Date (currentDate) )
            currentDate = currentDate.addDays(1);
        }
        return dateArray;
    }

    var week = new Week({ dates: [ new Date().toISOString().split("T")[0] ] })
    var weekView = new WeekView({ model: week })
    $('.widget-content').html(weekView.$el)

    var WeekRouter = Backbone.Router.extend({
        routes: {
            '': 'default',
        },
        initialize: function() {
            var router = this,
            routes = [
            [ /^(\d{4}-\d{2}-\d{2})$/, 'getDate', this.date],
            [ /^from(\d{4}-\d{2}-\d{2})to(\d{4}-\d{2}-\d{2})$/, 'getDate', this.dateRange],
            ]
            _.each(routes, function(route) {
                router.route.apply(router, route)
            })
        },
        default: function() { week.fetch(); },
        date: function(d) {
            _.each(_.keys(week.get("dates")), function(dd) {
                if (dd != d)
                    delete week.get("dates")[dd]
            })
            week.get("dates")[d] = undefined
            week.fetch()
        },
        dateRange: function(start, end) {
            start = new Date(start)
            end = new Date(end)
            var dates = _.map(getDates(start, end), function(tof) { return tof.toISODate(); })
            console.log("dateRange"+dates)
            _.each(_.keys(week.get("dates")), function(dd) {
                if (dates.indexOf(dd) < 0)
                    delete week.get("dates")[dd]
            })
            _.each(dates, function(d) {
                week.get("dates")[d] = undefined
            })
            week.fetch()
        },
    })
    var dashboard_router = new WeekRouter()

    Backbone.history.start()

</script>
{% endaddtoblock %}
{% addtoblock "css" %}
<link href="{{ STATIC_URL }}stables/css/dashboard.css" rel="stylesheet" type="text/css" />
<link href="{{ STATIC_URL }}stables/css/course.css" rel="stylesheet" type="text/css" />
{% endaddtoblock %}

<script type="text/html" id="ParticipationView">
    <select name="horse">
        <option value="0">{% trans "--" %}</option>
        {% for h in horses %}
        <option value="{{ h.pk }}">{{ h.name }}</option>
        {% endfor %}
    </select>
    <span class="ui-stbl-db-user alert alert-<%= alert_level %>"
    <% if (state != 0 ) { %>
        style="text-decoration: line-through;"
    <% } %>
    >
    <% if (finance_url != null) { %>
        <a href="<%= finance_url %>" title="<%= finance_hint %>"><%= finance %></a>
    <% } %>
    <a href="<%= rider_url %>"><%= rider_name %></a>
    </span>
    <select name="state">
        {% for s in states %}
        <option value="{{ s.0 }}">{{ s.1 }}</option>
        {% endfor %}
    </select>
    <div class="note">
    <textarea name="note"><%= note %></textarea>
    </div>
</script>

<script type="text/html" id="EventView">
    <span title='from <%= start %> to <%= end %>'><%= title %></span>
    <ul class="rider-list">
    </ul>
</script>

<script type="text/html" id="WeekView">
    <table class="timetable">
      <thead>
      </thead>
      <tbody>
      </tbody>
    </table>
</script>

<div class="wide widget">

  <div class="widget-content">
  </div>
</div>


{% endblock content %}
